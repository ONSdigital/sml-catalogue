{%- extends "core.html" -%}
{% if cms_enabled %}
  {%- set page_title = method.name -%}
{% else %}
  {%- set page_title = page.title -%}
{% endif %}
{%- set current_path = url_for("display_methods") -%}
{% from "components/external-link/_macro.njk" import onsExternalLink %}
{%- set breadcrumbs = {
  "id":"breadcrumbs",
  "ariaLabel":"breadcrumbs",
  "itemsList":[
    {
      "url": url_for("display_methods"),
      "id": "back",
      "text": 'Back',
    }
  ]
} -%}
{% from "components/status/_macro.njk" import onsStatus %}
{%- block main -%}

{% if cms_enabled %}

    <h1 class="ons-u-mt-no">Method: {{ method.name }}</h1>
    <h2> Method summary </h2>
    {{ method.description | markdown }}

    <h2> Contact details for this method </h2>
      {% from "components/external-link/_macro.njk" import onsExternalLink %}
    {% if method.contact_details %}
      {{
          onsExternalLink({
            "url": 'mailto:' ~ method.contact_details ,
            "linkText": method.contact_details  
          })
      }}
    {% endif %}
    {% from "components/metadata/_macro.njk" import onsMetadata %}
    {% set items = [] %}
    {% if method.method_ready %}
      {% set status = 'success' %}
    {% else %}
      {% set status = 'pending' %}
    {% endif %}
    {% for item in method.method_metadata %}
    {% set description = page.method_metadata[item] %}
    {% do
      items.append(
        {
            "term": item,
            "descriptions": [
                {
                    "description": description or "<em>n/a</em>"
                }
            ]
        }
      )
    %}
    {% endfor %}
    {% if method.method_ready %}
        {% set link = method.release_link %}
        {% set release_temp=
          '<span class="ons-status ons-status--' + status + '">
          <a href='+ link + ' target="_blank" rel="noopener noreferrer">
            <span class="ons-u-vh">Release version</span>
            ' + method.release_version + '
            <span class="ons-u-vh">(opens in a new tab)</span>
          </a>
        </span>' %}
    {% else %}    
      {% set release_temp='<span class="ons-status ons-status--' + status + '">Not Released Yet</span>' %}
    {% endif %}
    <hr class="ons-u-mb-m">
    {{
      onsMetadata({
        "classes": "ons-u-mb-no ",
        "metadataLabel": "Method information",
        "termCol": "3",
        "descriptionCol": "9",
        "itemsList": [
          {
            "term": "Author",
            "descriptions": [
              {
                "description": method.author
              }
            ]
          },
          {
            "term": "Expert group",
            "descriptions": [
              {
                "description": method.expert_group
              }
            ]
          },      
          {
            "term": "Theme",
            "descriptions": [
              {
                "description": method.theme
              }
            ]
          },
          {
            "term": "Languages",
            "descriptions": [
              {
                "description": method.language
              }
            ]
          },
          {
            "term": "Release",
            "descriptions": [
              {
                "description": release_temp
              }
            ]
          },
        ]
      })
    }}

{% else %}

    <h1 class="ons-u-mt-no">Method: {{ page.title }}</h1>
    <h2> Method summary </h2>
    {{ page.description | paras }}

    <h2> Contact details for this method </h2>
    {% if page.contact_details %}
      {{
          onsExternalLink({
            "url": 'mailto:' ~ page.contact_details ,
            "linkText": page.contact_details  
          })
      }}
    {% endif %}

    {% from "components/metadata/_macro.njk" import onsMetadata %}
    {% set items = [] %}
    {% set status =  page.additional_data["Release Status"] %}
    {% for item in page.method_metadata %}
    {% set description = page.method_metadata[item] %}

    {% do
      items.append(
        {
            "term": item,
            "descriptions": [
                {
                    "description": description or "<em>n/a</em>"
                }
            ]
        }
      )
    %}
    {% endfor %}

    {% for item in items %}
    {% if item["term"]  == "Release" %}
        {% set temp=item["descriptions"][0]["description"] %}

    {% if temp=="Not Released Yet" %}
        {% set item=item["descriptions"][0].__setitem__("description", '<span class="ons-status ons-status--' + status + '">' + temp + '</span>') %}

    {% else %}
        {% set link = page.additional_data["Release Link"] %}
        {% set item=item["descriptions"][0].__setitem__("description", 
        '<span class="ons-status ons-status--' + status + '">
          <a href='+ link + ' target="_blank" rel="noopener noreferrer">
            <span class="ons-u-vh">Release version</span>
            ' + temp + '
            <span class="ons-u-vh">(opens in a new tab)</span>
          </a>
        </span>') %}

    {% endif %}
    {% endif %}
    {% endfor %}
    <hr class="ons-u-mb-m">
    {{
      onsMetadata({
          "classes": "ons-u-mb-no ",
          "metadataLabel": "Method information",
          "termCol": "3",
          "descriptionCol": "9",
          "itemsList": items
      })
    }}

{% endif %}

<hr class="ons-u-mb-m">

<h2>GitHub resources</h2>
{% if cms_enabled %}
  {% set additional_info = method.additional_information | paras %}
  {% set specification_link = method.specification_link %}
  {% set method_name = method.name %}
  {% set code_link = method.code_link %}
  {% set user_documentation_link = method.user_documentation_link %}
{% else %}
  {% set additional_info = page.additional_info | paras %}
  {% set specification_link = page.specification_link %}
  {% set method_name = page.title %}
  {% set code_link = page.code_link %}
  {% set user_documentation_link = page.user_documentation_link %}
{% endif %}

{{ additional_info }}
{% if specification_link %}
{{
  onsExternalLink({
    "url": specification_link,
    "linkText":"Go to " ~ method_name ~ " specification on GitHub"
  })
}}
<br>
{% endif %}
{% if code_link %}
{{
  onsExternalLink({
    "url":code_link,
    "linkText":"Go to " ~ method_name ~ " code on GitHub"
  })
}}
<br>
{% endif %}
{% if user_documentation_link %}
{{
  onsExternalLink({
    "url":user_documentation_link,
    "linkText":"Go to "~ method_name ~" user documentation on GitHub"
  })
}}
{% endif %}

{%- endblock main -%}